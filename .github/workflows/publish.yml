name: publish

on: [ pull_request, workflow_dispatch ]

jobs:
  publish:
    strategy:
        matrix:
          project: [ client, server ]
          platform: [ win-x64, win-x86, win-arm64, linux-x64 ]
          self-contained: [ true, false ]
          PublishSingleFile: [ true, false ]
          PublishReadyToRun: [ true, false ]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 7.0.x
    
    - name: Publish
      run: |
        mkdir /tmp/publish
        dotnet publish ${{ matrix.project }}  --output /tmp/publish --runtime ${{ matrix.platform }} --self-contained ${{ matrix.self-contained }} -p:PublishSingleFile=${{ matrix.PublishSingleFile }} -p:PublishReadyToRun=${{ matrix.PublishReadyToRun }}
        cd /tmp/publish
        zip -c -p ghg-online-${{ matrix.project }}-${{ matrix.platform }}-${{ matrix.self-contained }}-${{ matrix.PublishSingleFile }}-${{ matrix.PublishReadyToRun }}.zip *
    
    - name: Upload manifest
      uses: actions/upload-artifact@v3
      with:
        name: packages
        path: /tmp/publish/ghg-online-${{ matrix.project }}-${{ matrix.platform }}-${{ matrix.self-contained }}-${{ matrix.PublishSingleFile }}-${{ matrix.PublishReadyToRun }}.zip
